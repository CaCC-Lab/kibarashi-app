name: Dependencies Check

on:
  schedule:
    # æ¯é€±æœˆæ›œæ—¥ã®9:00 UTCã«å®Ÿè¡Œ
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Update type'
        required: true
        default: 'security'
        type: choice
        options:
          - security
          - minor
          - all

env:
  NODE_VERSION: '20.x'

jobs:
  # ä¾å­˜é–¢ä¿‚ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
  security-check:
    name: Security Vulnerability Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run security audit (Root)
        run: |
          echo "ğŸ” ãƒ«ãƒ¼ãƒˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯"
          npm audit --audit-level=high

      - name: Run security audit (Frontend)
        run: |
          echo "ğŸ” ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯"
          cd frontend && npm audit --audit-level=high

      - name: Run security audit (Backend)
        run: |
          echo "ğŸ” ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯"
          cd backend && npm audit --audit-level=high

      - name: Check for outdated packages
        run: |
          echo "ğŸ“… å¤ã„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒã‚§ãƒƒã‚¯"
          npm outdated || true
          cd frontend && npm outdated || true
          cd ../backend && npm outdated || true

  # ä¾å­˜é–¢ä¿‚ã®è‡ªå‹•æ›´æ–°ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¿®æ­£ã®ã¿ï¼‰
  auto-update:
    name: Auto-update Dependencies
    runs-on: ubuntu-latest
    needs: [security-check]
    if: github.event.inputs.update_type == 'security' || github.event_name == 'schedule'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Update security vulnerabilities (Root)
        run: |
          echo "ğŸ”§ ãƒ«ãƒ¼ãƒˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¿®æ­£"
          npm audit fix --only=prod || true

      - name: Update security vulnerabilities (Frontend)
        run: |
          echo "ğŸ”§ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¿®æ­£"
          cd frontend && npm audit fix --only=prod || true

      - name: Update security vulnerabilities (Backend)
        run: |
          echo "ğŸ”§ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¿®æ­£"
          cd backend && npm audit fix --only=prod || true

      - name: Run tests after updates
        run: |
          echo "ğŸ§ª æ›´æ–°å¾Œã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"
          npm run test:frontend || echo "âš ï¸ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆå¤±æ•—"
          npm run test:backend || echo "âš ï¸ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆå¤±æ•—"

      - name: Check if there are changes
        id: verify-changed-files
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ å¤‰æ›´ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“"
          fi

      - name: Create Pull Request
        if: steps.verify-changed-files.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'fix: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã®ä¿®æ­£'
          title: 'ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã®è‡ªå‹•ä¿®æ­£'
          body: |
            ## æ¦‚è¦
            ä¾å­˜é–¢ä¿‚ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã‚’è‡ªå‹•çš„ã«ä¿®æ­£ã—ã¾ã—ãŸã€‚
            
            ## å¤‰æ›´å†…å®¹
            - `npm audit fix` ã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¿®æ­£ã‚’é©ç”¨
            - ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªæ¸ˆã¿
            
            ## ç¢ºèªäº‹é …
            - [ ] CIãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãŒæˆåŠŸã™ã‚‹ã“ã¨
            - [ ] ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã“ã¨
            
            ---
            ğŸ¤– ã“ã®PRã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚
          branch: security-updates
          delete-branch: true

  # ä¾å­˜é–¢ä¿‚ã®ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯
  license-check:
    name: License Compliance Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install license checker
        run: npm install -g license-checker

      - name: Install dependencies
        run: npm ci

      - name: Check licenses (Frontend)
        run: |
          echo "ğŸ“œ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯"
          cd frontend && license-checker --summary

      - name: Check licenses (Backend)
        run: |
          echo "ğŸ“œ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯"
          cd backend && license-checker --summary

      - name: Check for problematic licenses
        run: |
          echo "âš ï¸ å•é¡Œã®ã‚ã‚‹ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã®ãƒã‚§ãƒƒã‚¯"
          # å•†ç”¨åˆ©ç”¨ã§å•é¡Œã®ã‚ã‚‹ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯
          cd frontend && license-checker --excludeLicenses 'MIT;Apache-2.0;ISC;BSD-2-Clause;BSD-3-Clause;Unlicense;CC0-1.0' --failOn 'GPL;AGPL;LGPL;WTFPL;NPSL' || true
          cd ../backend && license-checker --excludeLicenses 'MIT;Apache-2.0;ISC;BSD-2-Clause;BSD-3-Clause;Unlicense;CC0-1.0' --failOn 'GPL;AGPL;LGPL;WTFPL;NPSL' || true

  # ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
  report:
    name: Generate Dependency Report
    runs-on: ubuntu-latest
    needs: [security-check, license-check]
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate dependency tree
        run: |
          echo "ğŸŒ³ ä¾å­˜é–¢ä¿‚ãƒ„ãƒªãƒ¼ã‚’ç”Ÿæˆ"
          npm ls --all > dependency-tree.txt || true
          cd frontend && npm ls --all > ../frontend-dependencies.txt || true
          cd ../backend && npm ls --all > ../backend-dependencies.txt || true

      - name: Upload dependency reports
        uses: actions/upload-artifact@v4
        with:
          name: dependency-reports
          path: |
            dependency-tree.txt
            frontend-dependencies.txt
            backend-dependencies.txt
          retention-days: 30